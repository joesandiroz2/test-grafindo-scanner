<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Yamaha Permintaan  Barang</title>
<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

</head>
<body>

<div id="navbar-container"></div>

<div class="row p-3">
    <div class="col-md-6 col-sm-12 col-lg-6"> 
        <div class="container mt-2">

<img 
style="width:120px" 
src="../../logo/yamaha_logo.png" alt="">
<h3 style="color:red;font-weight: bold;">Yamaha Permintaan Barang</h3>
<p>Fungsi ini untuk mengurangi stok / Balance terakhir barang,bisa digunakan untuk Aktualkan Stok atau Keluar Permintaan barang</p>
<div class="row">
<div class="col-sm-12 col-md-12 col-lg-12">
<div
style="border: 2px solid black;padding: 3px;margin:15px;padding: 5px;"
class="container">
<h6 style="color:red;font-weight:bold">Scan Qr Partnumber yg mau  Di kurangi diSini</h6>
<input type="text" 
autofocus style="color:red;font-weight: bold;"
id="scan-qr-partnumber"
class="form-control"placeholder="Scan Qr Partnumber disini">
</div>
</div>
</div>

<!--search select -->
<div class="form-group" style="border:2px solid black;padding:5px">
  <label for="search-part">Cari Part Number</label>
  <p id="loading-progress" style="color:purple;font-weight:bold">sedang memuat semua part...</p>
  <select id="search-part" class="form-control" style="width:100%"></select>
</div>



<div class="row">
<div class="col-md-6 col-sm-12 col-lg-6">
<div class="form-group">
<label for="part-number">Part Number</label>
<input type="text"
style="font-weight: bold;color:red;font-size: 25px;"
 id="part-number" class="form-control" placeholder="Masukkan Part Number">
</div>
</div>
<div class="col-md-6">
<div class="form-group">
<label for="no-lot">No Lot</label>
<input type="text"
style="font-weight: bold;color:red;font-size: 25px;"
 id="no-lot" class="form-control" placeholder="Masukkan No Lot">
</div>
</div>
</div>

<div class="row">
<div class="col-md-6">
<div class="form-group">
<label for="no-lot">Nama Barang</label>
<input type="text"
style="font-weight: bold;font-size: 25px;"
 id="namabarang" class="form-control" placeholder="nama barang">
</div>
</div>
    <div class="col-md-2">
<div class="form-group">
<label for="no-lot">Qty yg mau di kurangi</label>
<input type="text"
style="font-weight: bold;color:red;font-size: 25px;"
 id="qtykurangi" class="form-control" placeholder="Qty ">
</div>
</div>

<div class="col-md-4">
<div class="form-group">
<label 
style="font-weight: bold;"
for="no-lot">*Alasan Pengurangan Stok ( ketik sesuai keinginan)</label>
<input type="text"
style="font-weight: bold;color:red;font-size: 25px;"
 id="alasan_kurangi" value="PB " class="form-control" placeholder="Alasan Pengurangan">
</div>
</div>
</div>
<button id="search-button" class="btn btn-primary">Cari</button>
<button id="kurangi-button" class="btn btn-danger">Kurangi Stok</button>

<div id="result-container" class="table-responsive mt-3"></div>
<div id="latest-data-container" class="table-responsive"></div>
<div id="error-container"></div>
</div>



    </div>
    <div class="col-md-6 col-sm-12 col-lg-6"> 
        <!-- table history keluar -->
<div class="row mt-3">
  <div class="col-md-12 col-lg-12">
    <div id="tabel_keluar" class="table-responsive" style="border:2px solid black;padding:5px">
      <h6 style="color:red;font-weight:bold">Data Permintaan barang Keluar terbaru</h6>
      <table id="tbl_permintaan_keluar" class="table table-bordered table-striped"></table>
    </div>
  </div>
</div>
    </div> 
</div>


<script src="../../js/sdk/pocketbase.umd.js"></script>
<script src="../../js/pocket_config.js"></script>
<script src="./js/yamaha_kesalahan_input.js"></script>
<script src="./js/yamaha_cari_part_salah.js"></script>
<script src="./js/yamaha_list_keluar.js"></script>
<script>
const pb = new PocketBase(pocketbaseUrl);

$(document).ready(function() {
$("#navbar-container").load("../../component/nav.html",function(){
        setTimeout(loginUser, 500);
    
});

$("#kurangi-button").on("click", function() {
Kurangi_stok_part(); // Panggil fungsi dari file masukkan_qty.js
});

let inputTimeout;


$('#scan-qr-partnumber').on('input', function() {
    clearTimeout(inputTimeout);

    const inputValue = $(this).val().trim();

    inputTimeout = setTimeout(function() {
        if (inputValue) {
            // Pisahkan berdasarkan spasi
            const parts = inputValue.split(/\s+/);

            // Validasi: minimal harus ada 3 blok
            if (parts.length < 3) {
                Swal.fire({
                    timer: 1500,
                    icon: 'error',
                    title: 'Format QR Tidak Sesuai',
                    text: 'QR harus berisi PartNumber, Qty, dan Lot (dipisahkan spasi).',
                });

                const audio = new Audio('../../suara/partnumber_ga_standar_scan.mp3');
                audio.play();

                $('#scan-qr-partnumber').val('');
                return;
            }

            // Ambil nilai sesuai urutan
            const partNumber = parts[0];
            const qty = parts[1];
            const lot = parts[2];

            // Set ke input
            $('#part-number').val(partNumber);
            $('#qtykurangi').val(qty);
            $('#no-lot').val(lot);

            // Otomatis klik tombol Cari
            $('#search-button').click();

            // Hapus inputan scan setelah 1.3 detik
            $('#scan-qr-partnumber').val('');
        }
    }, 500);
});

});



async function loadAllParts() {
    let page = 1;
    let totalPages = 1;
    let allItems = [];
    let totalItems = 0;

    while (page <= totalPages) {
        const res = await fetch(`http://192.168.0.99:8090/api/collections/yamaha_unik_part_number/records?page=${page}&perPage=30`);
        const data = await res.json();

        totalPages = data.totalPages;
        totalItems = data.totalItems; // total semua item
        allItems = allItems.concat(data.items);

        // Update progress
        const progressEl = document.getElementById("loading-progress");
        progressEl.innerText = `Sedang memuat semua part, proses ${allItems.length} dari ${totalItems}`;

        page++;
    }

    return allItems;
}

$(document).ready(async function() {
    $("#navbar-container").load("../../component/nav.html", function() {
        setTimeout(loginUser, 500);
    });

    $("#kurangi-button").on("click", function() {
        Kurangi_stok_part();
    });

    // Load semua part number
    const allParts = await loadAllParts();

    // Setelah selesai, ubah text jadi selesai
    document.getElementById("loading-progress").innerText = `Selesai ok`;

    // Mapping data untuk select2
    const selectData = allParts.map(item => ({
        id: item.part_number,
        text: `${item.part_number} - ${item.nama_barang}`
    }));

    // Init select2
    $("#search-part").select2({
        placeholder: "Cari Part Number...",
        data: selectData
    });

    // Kalau user pilih, isi otomatis ke input
    $("#search-part").on("select2:select", function(e) {
        const selected = e.params.data;
        const found = allParts.find(x => x.part_number === selected.id);

        if (found) {
            $("#part-number").val(found.part_number);
            $("#namabarang").val(found.nama_barang);
        }
    });
});

</script>
</body>
</html>