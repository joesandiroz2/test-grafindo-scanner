<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Aplikasi Yamaha</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
<!-- Select2 CSS + JS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

</head>
<body>

<div id="navbar-container"></div>

<div class="container mt-2">
  <a class="btn btn-info" href="/yamaha/yamaha_penyerahan_barang/yamaha_input_set/yamaha_input_set.html">Input Dengan SET</a>
    <a class="btn btn-warning" href="/yamaha/yamaha_penyerahan_barang/yamaha_edit_nama_set/yamaha_edit_nama_set.html">Edit Nama Set</a>
</div>

<div class="m-4">
  <div class="row">
    <!-- Form Input -->
    <div class="col-md-5" style="border:2px solid black;">
  <div style="display: flex; justify-content: space-between; align-items: center;">
    <img src="../../logo/yamaha_logo.png" style="width: 120px; height: 80px; object-fit: contain;" alt="Yamaha Logo">
    <h4 class="mb-0" style="margin-left: 10px; flex-grow: 1; text-align: right;font-weight: bold;">Input Penyerahan Barang</h4>
  </div>

      <div class="row" style="margin:20px"> 
            <input type="text" id="scan_input_part" placeholder="Auto scan input partnumber"
            style="font-weight:bold;font-size:20px"
            />
      </div>
      
    <div class="mb-3" style="border:5px solid black;margin:20px;padding:20px">
      <label for="selectPart" class="form-label">Cari Part Number</label>
      <p id="loadingText" style="color:purple;font-weight:bold">sedang mengumpulkan semua part...</p>
      <select id="selectPart" class="form-control" style="width:100%"></select>
    </div>



      <form id="pbForm">

        <div class="row g-3">
          <div class="col-12 col-md-6 col-xl-10">
            <input type="text" class="form-control" id="part_number" placeholder="Part Number" list="partNumberList" 
            style="font-weight:bold" 
             required>
            <datalist 
             
            id="partNumberList"></datalist>
          </div>
          <div class="col-12 col-md-6 col-xl-5">
            <input type="text" class="form-control" 
            style="font-weight:bold" 
             id="nama_barang" placeholder="Nama Barang" required>
          </div>
          <div class="col-12 col-md-6 col-xl-10" style="font-weight:bold">
            LOT: 
            <input type="text" class="form-control" id="lot" placeholder="Lot" required>
            
          </div>
         
          <div class="col-12 col-md-6 col-xl-5" style="font-weight:bold">
            No PB:
            <input type="text" class="form-control" id="no_pb" placeholder="No PB" required>
          </div>
           <div class="col-12 col-md-6 col-xl-5" style="font-weight:bold">
            TGL PB:
            <input type="date" class="form-control" id="tgl_pb" required>
          </div>
          <div class="col-12 col-md-6 col-xl-5" style="font-weight:bold">
            Qty Masuk:
            <input type="number" class="form-control" id="qty_masuk" placeholder="Qty Masuk" required>
          </div>
        </div>
        <div class="mt-4">
          <button type="submit" id="submitBtn" class="btn btn-success">
            <i class="bi bi-box-arrow-in-down"></i> Tambahkan
          </button>
        </div>
      </form>
    </div>

    <!-- Lorem Ipsum Text -->
    <!-- Data Penyerahan -->
<div class="col-md-7 col-sm-12">
  <div class="bg-info p-3 rounded">
    <h5>Data Pb terakhir</h5>

    <div>
      <input type="text" id="searchInput" placeholder="cari partnumber">
      <button id="searchBtn">cari</button>
      <button id="resetBtn">reset</button>
    </div>
    <h6 id="searchInfo" class="mt-2"></h6>

    <table class="table table-sm table-bordered table-striped">
      <thead>
        <tr>
          <th>No</th>
          <th>Part</th>
          <th>Nama</th>
          <th>Lot</th>
          <th>qty</th>
          <th>Terakhir Masuk</th>
        
        </tr>
      </thead>
      <tbody id="penyerahanData">
        <!-- Data akan dimuat lewat JS -->
      </tbody>
    </table>
  </div>
</div>

  </div>
</div>



<!-- Modal Ganti Lot -->
<div class="modal fade" id="modalGantiLot" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-warning">
        <h5 class="modal-title">Ganti Lot</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="recordId">
        <div class="mb-3">
          <label for="lotBaru" class="form-label">Lot Baru</label>
          <input type="text" id="lotBaru" class="form-control" placeholder="Masukkan lot baru">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" id="btnSimpanLot" class="btn btn-success">Simpan</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap & jQuery -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>


<!-- External JS -->
<script src="../../js/sdk/pocketbase.umd.js"></script>
<script src="../../js/pocket_config.js"></script>

<script src="./js/yamaha_penyerahan_barang.js"></script>
<script src="./js/yamaha_auto_complete_part_number.js"></script>
<script src="./js/yamaha_load_penyerahan.js"></script>


<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
  $(document).ready(function () {
    $("#navbar-container").load("../../component/nav.html", function () {
      setTimeout(loginUser, 500);
    });
  });


document.getElementById("scan_input_part").addEventListener("input", async function () {
  let inputVal = this.value.trim();

  // pecah string berdasarkan spasi
  let parts = inputVal.split(" ");

  if (parts.length >= 3) {
    let partNumber = parts[0];
    let qty = parts[1];
    let lot = parts[2];

    // isi otomatis ke inputan
    document.getElementById("part_number").value = partNumber;
    document.getElementById("qty_masuk").value = qty;
    document.getElementById("lot").value = lot;

    try {
      // Panggil API PocketBase untuk cari part_number
      let url = `${pocketbaseUrl}/api/collections/yamaha_unik_part_number/records?filter=part_number="${partNumber}"`;

      let response = await fetch(url);
      let data = await response.json();

      if (data.items && data.items.length > 0) {
        let namaBarang = data.items[0].nama_barang || "";
        document.getElementById("nama_barang").value = namaBarang;
      Swal.fire({
        title: "Barang Ketemu",
        text: "barang ditemukan",
        icon: "success",
        timer: 1000,
        showConfirmButton: false
      });

      } else {
        document.getElementById("nama_barang").value = "";
        Swal.fire("Not Found", "Nama barang tidak ditemukan di database", "warning");
      }
    } catch (err) {
      console.error(err);
      Swal.fire("Error", "Gagal ambil data dari server", "error");
    } finally {
      // clear input scan supaya siap scan berikutnya
      document.getElementById("scan_input_part").value = "";
      document.getElementById("scan_input_part").focus();
    }
  }
});


//loadpartnumber dengan progress
async function loadAllPartNumbers() {
  let allItems = [];
  let page = 1;
  let perPage = 50;

  // ambil totalPages dulu
  let urlFirst = `${pocketbaseUrl}/api/collections/yamaha_unik_part_number/records?page=1&perPage=${perPage}`;
  let resFirst = await fetch(urlFirst);
  let dataFirst = await resFirst.json();

  let totalPages = dataFirst.totalPages;
  let totalItems = dataFirst.totalItems; // total semua part
  allItems = allItems.concat(dataFirst.items);

  // update progress pertama
  $("#loadingText").text(`Sedang mengumplkan part : proses ${allItems.length} dari ${totalItems} part...`);

  // loop mulai dari page 2
  for (page = 2; page <= totalPages; page++) {
    let url = `${pocketbaseUrl}/api/collections/yamaha_unik_part_number/records?page=${page}&perPage=${perPage}`;
    let res = await fetch(url);
    let data = await res.json();

    allItems = allItems.concat(data.items);

    // update progress setiap kali page selesai diambil
    $("#loadingText").text(`Memuat ${allItems.length} dari ${totalItems} part...`);
  }

  return allItems;
}


$(document).ready(async function() {
  // tampilkan loading
  $("#loadingText").show();

  let partData = await loadAllPartNumbers();

  // setelah selesai → sembunyikan loading
  $("#loadingText").hide();

  // convert ke format Select2
  let options = partData.map(item => ({
    id: item.part_number,
    text: `${item.part_number} - ${item.nama_barang}`,
    nama_barang: item.nama_barang
  }));

  $("#selectPart").select2({
    placeholder: "Ketik Part Number / Nama Barang",
    allowClear: true,
    data: options
  });

  // ketika dipilih → isi inputan form
  $("#selectPart").on("select2:select", function(e) {
    let data = e.params.data;
    $("#part_number").val(data.id);
    $("#nama_barang").val(data.nama_barang);
  });
});

</script>


</body>
</html>
