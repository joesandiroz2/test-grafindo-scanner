<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Edit Jumlah Barang DO</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="../../js/sdk/pocketbase.umd.js"></script>

  <script src="../../js/pocket_config.js"></script>

</head>
<body class="p-4">
  <div class="container">
    <a href="/pages/semua_do"
    class="btn btn-danger"
    >kembali</a>
    <h3 class="mb-4">Edit Jumlah Barang DO</h3>
    
    <div class="mb-3">
      <label for="noDoInput" class="form-label">Masukkan No DO</label>
      <input type="text" id="noDoInput" class="form-control" placeholder="Contoh: DO-A-2505000148">
    </div>
    <button class="btn btn-primary" id="searchBtn">
    Cari
    <span class="spinner-border spinner-border-sm d-none" id="searchSpinner" role="status" aria-hidden="true"></span>
  </button>


    <div id="editSection" class="mt-4" style="display: none;">
      <div class="mb-3">
        <label for="jumlahBarangInput" class="form-label">Edit Jumlah Barang DO</label>
        <input type="number" id="jumlahBarangInput" class="form-control" min="0">
      </div>
      <button class="btn btn-success" id="editBtn">
        Edit
        <span class="spinner-border spinner-border-sm d-none" id="loadingSpinner" role="status" aria-hidden="true"></span>
      </button>
    </div>

    <table class="table table-bordered table-striped mt-4" id="resultTable" style="display: none;">
      <thead>
        <tr>
          <th>No</th>
          <th>No DN</th>
          <th>Part Number</th>
          <th>nama barang</th>
          <th>Qty</th>
          <th>Jumlah Barang DO</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>

  <script>
    const pb = new PocketBase(pocketbaseUrl); // Ganti dengan alamat PocketBase Anda

   
    let currentData = [];

    async function login() {
      await pb.collection('users').authWithPassword(username_pocket, user_pass_pocket);
    }

    async function searchByNoDN(no_dn) {
      const result = await pb.collection('kartu_stok').getFullList({
        filter: `no_dn="${no_dn}"`
      });
      return result;
    }

    async function updateJumlahBarangDO(dataList, jumlahBaru) {
      const updatePromises = dataList.map(item => {
        return pb.collection('kartu_stok').update(item.id, {
          jumlah_barang_do: jumlahBaru
        });
      });
      return Promise.all(updatePromises);
    }

    function renderTable(data) {
      const tbody = document.getElementById('tableBody');
      tbody.innerHTML = '';
      data.forEach((item, index) => {
        const row = `<tr>
         <td>${index + 1}</td>
          <td>${item.no_dn}</td>
          <td>${item.part_number}</td>
          <td>${item.nama_barang}</td>
          <td>${item.qty_minta}</td>
          <td>${item.jumlah_barang_do}</td>
        </tr>`;
        tbody.innerHTML += row;
      });
      document.getElementById('resultTable').style.display = 'table';
    }

    document.getElementById('searchBtn').addEventListener('click', async () => {
      const noDnValue = document.getElementById('noDoInput').value.replace(/\s+/g, '').toUpperCase();

      if (!noDnValue) return alert("Masukkan No DO");

      const searchBtn = document.getElementById('searchBtn');
      const searchSpinner = document.getElementById('searchSpinner');
      searchBtn.disabled = true;
      searchSpinner.classList.remove('d-none');

      try {
        await login();
        currentData = await searchByNoDN(noDnValue);
        if (currentData.length > 0) {
          renderTable(currentData);
          document.getElementById('editSection').style.display = 'block';
        } else {
          alert("Data tidak ditemukan");
          document.getElementById('editSection').style.display = 'none';
          document.getElementById('resultTable').style.display = 'none';
        }
      } catch (err) {
        alert("Gagal mengakses PocketBase");
        console.error(err);
      }finally {
    searchBtn.disabled = false;
    searchSpinner.classList.add('d-none');
    }
    });

    document.getElementById('editBtn').addEventListener('click', async () => {
      const newJumlah = document.getElementById('jumlahBarangInput').value.trim();
      if (newJumlah === "") return alert("Masukkan jumlah barang DO baru");

      const btn = document.getElementById('editBtn');
      const spinner = document.getElementById('loadingSpinner');
      btn.disabled = true;
      spinner.classList.remove('d-none');

      try {
        await updateJumlahBarangDO(currentData, newJumlah);
        // Refresh data
        const noDnValue = document.getElementById('noDoInput').value.trim();
        currentData = await searchByNoDN(noDnValue);
        renderTable(currentData);
      } catch (err) {
        alert("Gagal update data");
        console.error(err);
      } finally {
        btn.disabled = false;
        spinner.classList.add('d-none');
      }
    });
  </script>
</body>
</html>
