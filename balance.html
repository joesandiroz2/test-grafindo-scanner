<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Create Yamaha Kartu Stok</title>
   <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Bootstrap -->
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">

  <!-- SweetAlert2 -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script src="./js/sdk/pocketbase.umd.js"></script>
  <script src="./js/pocket_config.js"></script>

  <style>
    #preloader {
      display: none;
      text-align: center;
      margin-top: 30px;
    }
  </style>
</head>
<body>
  <div id="navbar-container"></div>

  <div class="row">  
      <div class="col-md-6 col-lg-6 col-sm-12"> 
        <h4 class="mb-3">Form Balance Stok Yamaha Kartu Stok</h4>

        <div class="card shadow-lg mb-4" style="border-top:10px solid orange">
          <div class="card-body">
            <form id="stokForm">
              <div class="form-row">
                <div class="form-group col-md-4">
                  <label style="font-weight:bold" for="part_number">Part Number</label>
                  <input type="text" id="part_number" name="part_number" class="form-control" required>
                </div>
                <div class="form-group col-md-4">
                  <label style="font-weight:bold" for="balance">Balance yg mau dirubah</label>
                  <input type="number" id="balance" name="balance" class="form-control" required>
                </div>
                <div class="form-group col-md-4">
                  <label style="font-weight:bold" for="no_do">Keterangan Di kartu Stok</label>
                  <input style="font-weight:bold;font-size:18px"type="text" id="no_do" name="no_do" class="form-control" value="balance akhir bulan" required>
                </div>
              </div>
              <button type="submit" class="btn btn-primary">
                <i class="bi bi-save"></i> Simpan
              </button>
            </form>
          </div>
        </div>

        
      </div>
      <div class="col-md-6 col-lg-6 col-sm-12"> 
          <h5 class="mb-3">Data Balance Terakhir Part Yamaha</h5>
        <!-- Preloader -->
        <div id="preloader">
          <div class="spinner-border text-primary" role="status">
            <span class="sr-only">Loading...</span>
          </div>
          <p>Sedang memuat data...</p>
        </div>

        <table class="table table-striped table-bordered">
          <thead class="thead-dark">
            <tr>
              <th>No</th>
              <th>Part Number</th>
              <th>Balance Terbaru</th>
              <th>Ket</th>
              <th>Tanggal update</th>
            </tr>
          </thead>
          <tbody id="dataTable"></tbody>
        </table>

       </div>
  </div>
  

  <!-- Script -->
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>

   <script>

        $(document).ready(function() {
                $("#navbar-container").load("./component/nav.html", function() {
            setTimeout(loginUser, 500);
        });
        })
    </script>
  
  <script>
    const pb = new PocketBase(pocketbaseUrl);

    document.getElementById("part_number").addEventListener("input", function () {
    let val = this.value;
    val = val.replace(/\s+/g, ""); // hapus semua spasi
    val = val.toUpperCase(); // ubah ke huruf besar
    this.value = val; // set kembali ke input
  });

    function formatTanggal(dateStr) {
      const date = new Date(dateStr);
      const options = { day: '2-digit', month: 'long', year: 'numeric', hour: "2-digit", minute: "2-digit" };
      return date.toLocaleDateString("id-ID", options);
    }

    async function loadData() {
      const preloader = document.getElementById("preloader");
      const tbody = document.getElementById("dataTable");
      tbody.innerHTML = "";
      preloader.style.display = "block"; // tampilkan preloader

      try {
        await pb.collection("users").authWithPassword(username_pocket, user_pass_pocket);

        const result = await pb.collection("yamaha_kartu_stok").getList(1, 100, { sort: "-created" });
        preloader.style.display = "none"; // sembunyikan preloader

        if (result.items.length === 0) {
          tbody.innerHTML = `<tr><td colspan="4" class="text-center text-muted">Tidak ada data ditemukan</td></tr>`;
          return;
        }

        result.items.forEach((rec, i) => {
           const balance = parseFloat(rec.balance || 0);
          const color = balance < 0 ? "red" : "black";
          const tr = document.createElement("tr");

          tr.innerHTML = `
            <td>${i + 1}</td>
            <td style="font-weight:bold">${rec.part_number || "-"}</td>
             <td style="color:${color}; font-weight:bold;">${balance}</td>
            <td style="font-weight:bold">${rec.kode_depan + rec.no_do || "0"}</td>
            <td>${formatTanggal(rec.created)}</td>
          `;
          tbody.appendChild(tr);
        });

      } catch (err) {
        preloader.style.display = "none";
        console.error("❌ Gagal load data:", err);
        Swal.fire("Gagal memuat data!", "", "error");
      }
    }

    document.getElementById("stokForm").addEventListener("submit", async function (e) {
      e.preventDefault();
       const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;

    // Ubah tombol jadi "Sedang menyimpan stok..."
    submitBtn.disabled = true;
    submitBtn.innerHTML = `<span class="spinner-border spinner-border-sm mr-2"></span> Sedang menyimpan stok...`;


      try {
        await pb.collection("users").authWithPassword(username_pocket, user_pass_pocket);

        const partNumber = document.getElementById("part_number").value.replace(/\s+/g, "").trim().toUpperCase();
        const no_do = document.getElementById("no_do").value.trim();
        const balance = document.getElementById("balance").value.trim();

        const data = {
          kode_depan: "",
          no_do,
          part_number: partNumber,
          nama_barang: "",
          qty_scan: "",
          qty_do: "",
          status: "",
          remarks: "",
          balance,
          qty_masuk: "",
          tgl_pb: "",
          lot: "",
          jumlah_barang: "",
          tgl_do: "",
          budian: ""
        };

        await pb.collection("yamaha_kartu_stok").create(data);

        Swal.fire({
          toast: true,
          position: "top-end",
          icon: "success",
          title: "✅ Data berhasil disimpan!",
          showConfirmButton: false,
          timer: 1200,
          timerProgressBar: true
        });

        document.getElementById("stokForm").reset();
        loadData();

      } catch (err) {
        console.error("❌ Error:", err);
        Swal.fire("❌ Gagal menyimpan data!", "", "error");
      } finally {
      // Kembalikan tombol ke kondisi semula
      submitBtn.disabled = false;
      submitBtn.innerHTML = originalText;
    }
    });

   loadData()
  </script>
</body>
</html>
